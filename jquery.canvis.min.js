// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
// http://benpickles.github.io/peity
//
// CanVis jQuery plugin version 0.9.0
// (c) 2014 Fred Morel
// http://fmorel90.github.io/peity
//
// Released under MIT license.
(function(q,n,K,N){var P=document.createElement("canvas").getContext,O=function(a,b,c){this.$el=a;this.type=b;this.opt=c},G=O.prototype,w=q.fn.canvis=function(a,b){P&&this.each(function(){var c=q(this),d=c.data(K);if(d)a&&(d.type=a),q.extend(!0,d.opt,b),d.draw();else{var g=w.defaults[a],h={};q.each(c.data(),function(a,b){h[a]=b});g=q.extend({},g,h,b);d=new O(c,a,g);d.draw();c.change(function(){d.draw()}).data(K,d)}});return this};G.draw=function(){w.graphers[this.type].call(this,this.opt)};G.createCanvas=
function(a,b){var c=this.canvas;c||(this.canvas=c=q("<canvas/>",{"class":K})[0],this.context=c.getContext("2d",{alpha:!1}),this.$el.hide().removeData(N).after(c));c.width=a;c.height=b;u.rect(this.context,0,0,a,b,"#fff",0);q(c).css({height:b,width:a}).data(K,this);return c};G.values=function(){var a=function(a){return parseFloat(a)},b=arguments,c=this.$el.text().split(b[0]);return 1===b.length?c.map(a):c.map(function(c){return c.split(b[1]).map(a)})};var B=function(){return{color:"#000",size:13,formatter:function(a){return a}}},
C={labelLevels:function(a){return n.max.apply(this,a.map(function(a){return a.replace(/[^ ]/g,"").length}))+1},toString:function(a,b){return b?a.map(function(a){return""+b(a)}):a.map(function(a){return""+a})},extractor:function(a){return function(b){return b[a]}},toFunction:function(a){return q.isArray(a)?q.isArray(a[0])||q.isFunction(a[0])?a.map(function(a){return q.isFunction(a)?a:function(c,d){return a[d%a.length]}}):function(b,c){return a[c%a.length]}:a},getWidth:function(a,b){return a.measureText(b).width}};
G.addEvents=function(){q(this.canvas).on("mousemove mouseout",function(a){var b=this.getBoundingClientRect();q(this).off().prev().data(N,JSON.stringify({x:a.clientX-b.left,y:a.clientY-b.top})).change()})};var u={strokeLine_:function(a,b,c){a.lineWidth=b;a.strokeStyle=c;a.stroke()},arc:function(a,b,c,d,g,h,f,e){a.beginPath();a.arc(b,c,d,g,h,!0);u.strokeLine_(a,e,f)},circle:function(a,b,c,d,g,h,f){a.beginPath();a.moveTo(b,c);a.arc(b,c,d,g,h,!0);a.fillStyle=f;a.fill()},line:function(a,b,c,d){a.beginPath();
for(var g=0;g<b.length;g++)a.lineTo(n.round(b[g].x),n.round(b[g].y));u.strokeLine_(a,d,c)},rect:function(a,b,c,d,g,h,f,e){b=n.round(b);c=n.round(c);d=n.round(d);g=n.round(g);h&&(a.fillStyle=h,a.fillRect(b,c,d,g));e&&(a.strokeStyle=e,a.lineWidth=f,a.strokeRect(b,c,d,g))},tooltip:function(a,b,c,d,g,h,f,e,k,m,D){a.font=f+"px sans-serif";a.textAlign="left";a.textBaseline="top";d=C.toString(d,k).map(function(a,b){return""!==a?""!==g[b]?g[b]+": "+a:a:""});m&&d.splice(0,0,C.toString([m],D)[0]);d=d.filter(function(a){return""!==
a});var s=n.max.apply([],d.map(function(b){return C.getWidth(a,b)}));k=C.getWidth(a,"\u25a0");var r=s+k;b-=6;k=d.length*f;c>k-6&&(c-=k);b<=r+9&&(b+=r+20+9);u.rect(a,b-r-6,c-3,r+8,k+8,"#fff",1,"#000");m&&(a.fillStyle=e,a.fillText(d.splice(0,1)[0],b-r-2,c),c+=f);d.forEach(function(d,g){if(""!==d){var k=c+g*f;a.fillStyle=h[g%h.length];a.fillText("\u25a0",b-r-3,k);a.fillStyle=e;a.fillText(d,b-s-2,k)}})}};w.defaults={};w.graphers={};w.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};w.register("pie",
{fill:["#f90","#ffd","#fc6"],line:{color:"#000",width:0},focus:{color:"#000",width:0},delimiter:null,diameter:16,tooltip:B(),label:B()},function(a){var b=a.delimiter;b||(b=(b=this.$el.text().match(/[^0-9\.]/))?b[0]:",");var c=this.values.apply(this,[b]);"/"===b&&(c=[c[0],c[1]-c[0]]);var d,g=0,b=c.length;for(d=0;d<b;d++)g+=c[d];var h=this.$el.data(N),f=a.focus,e=a.line,k=n.max(f.width,e.width)+1,m=a.diameter,D=this.createCanvas(m+k,m+k),m=this.context;d=D.width;var s=D.height,k=d/2-k,D=2*n.PI,g=D/
g,r=C.toFunction(a.fill),v=a.tooltip,q=a.label,y,l,p=a.labels;p&&(p=C.toString(p));if(f.width&&h){l=JSON.parse(h);l.x-=d/2;l.y-=s/2;l.y*=-1;l.r=n.sqrt(l.x*l.x+l.y*l.y);for(l.a=n.atan2(l.y,l.x);0>l.a;)l.a+=D;for(;l.a>D;)l.a-=D}m.save();m.translate(d/2,s/2);var x,z=0;for(d=0;d<b;d++)s=c[d],x=s*g,u.circle(m,0,0,k,-z,-(z+x),r.call(this,s,d,c)),f.width&&l&&l.a>z&&l.a<z+x&&l.r<k&&(u.arc(m,0,0,k+f.width/2,-z,-(z+x),f.color,f.width),y=d),z+=x;e.width&&u.arc(m,0,0,k+e.width/2,0,D,e.color,e.width);f.width&&
(h&&void 0!==y&&(h=JSON.parse(h),m.restore(),u.tooltip(m,h.x,h.y,[c[y]],[a.name||""],[r.call(this,c[y],y,c)],v.size,v.color,v.formatter,p?p[y]:void 0,q.formatter)),this.addEvents())});w.register("combo",{series:[{type:"bar",color:["#48f"]},{type:"line",color:["#827"],width:1,points:3}],delimiters:["|",","],height:50,width:200,left:0,gap:1,seriesGap:0,max:null,min:0,xAxis:B(),yAxis:B(),tooltip:B(),focus:{color:"#000",width:0},gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=this,
c=b.values.apply(b,a.delimiters),d=c.length,g=[].concat.apply([a.max,a.min],c),h,f,e,k,m=a.labels,q=0;m&&(m=C.toString(m),q=C.labelLevels(m));var s=n.max.apply(n,c.map(function(a){return a.length}));f=n.max.apply(n,g);var r=n.min.apply(n,g),v,A=a.region||(f-r)/5;0!==f&&(f=n.ceil(f+A/2));0!==r&&(r=n.floor(r-A/2));v=f-r||1;var A=a.region||v/5,y=a.series,l=y.filter(function(a){return"bar"===a.type}).length,p=a.yAxis,g=a.xAxis,x=a.focus,z=a.tooltip,E=a.gridlines,w=b.$el.data(N),H=b.createCanvas(a.width,
a.height),t=b.context,F=H.width,B=a.gap,K=a.seriesGap;a=a.left;var H=H.height-(q*g.size+(q?4:0))-E.widths[0],G=f===r?0:H/v;v=(F-a-B*s)/s;E.widths[0]&&(k=H-G*(0-r),u.line(t,[{x:a,y:k},{x:F,y:k}],E.colors[0],E.widths[0]));if(E.widths[1])for(t.fillStyle=p.color,t.font=p.size+"px sans-serif",t.textAlign="right",h=r;h<=f;h+=A)k=H-G*(h-r),u.line(t,[{x:a,y:k},{x:F,y:k}],E.colors[1],E.widths[1]),a&&(t.textBaseline=k>p.size/2?k>H-p.size/2?"bottom":"middle":"top",t.fillText(""+p.formatter(h),a-2,k));var A=
[],E=-1,I,L,J,M,p=[];for(f=0;f<s;f++)p.push(a+(B+v)*(0.5+f));for(f=0;f<d;f++){I=c[f];J=y[f];M=J.color=C.toFunction(J.color);L=J.type;"bar"===L&&E++;F=[];for(e=0;e<I.length;e++)h=I[e],k=H-G*(h-r),"bar"===L?(s={x:a+B/2+e*(B+v)+v/l*E,y:k,w:v/l-K/2,h:0===h?1:G*h},u.rect(t,s.x,s.y,s.w,s.h,M.call(b,h,e,I),0)):s={x:p[e],y:k},F[e]=s,"step"===L&&h&&u.line(t,[{x:p[e]-v/2*0.62,y:k},{x:p[e]+v/2*0.62,y:k}],M.call(b,h,e,I),J.width);if("line"===L){for(e=0;e<F.length;e++)u.circle(t,F[e].x,F[e].y,J.points,0,2*n.PI,
M.call(b,I[e],e,I));u.line(t,F,M.call(b,I[0],0,I),J.width)}A.push(F.slice(0))}if(q)for(t.fillStyle=g.color,t.font=g.size+"px sans-serif",t.textBaseline="top",t.textAlign="center",f=0;f<p.length;f++)for(d=m[f].split(" "),e=0;e<d.length;e++)t.fillText(d[e],p[f],H+1+e*g.size);if(x.width){if(w)for(w=JSON.parse(w),e=0;e<p.length;e++)if(w.x>=p[e]-v/2&&w.x<=p[e]+v/2){for(f=0;f<A.length;f++)"bar"===y[f].type&&u.rect(t,A[f][e].x-x.width/2,A[f][e].y-x.width/2,A[f][e].w+x.width,A[f][e].h+x.width,void 0,x.width,
x.color);u.tooltip(t,w.x,w.y,c.map(C.extractor(e)),y.map(function(a){return a.name||""}),c.map(function(a,c){return y[c].color.call(b,a[e],e,a)}),z.size,z.color,z.formatter,m?m[e]:void 0,g.formatter);break}b.addEvents()}})})(jQuery,Math,"canvis","canvis-mouse");
