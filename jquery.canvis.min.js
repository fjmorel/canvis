// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
// http://benpickles.github.io/peity
//
// CanVis jQuery plugin version 0.9.0
// (c) 2014 Fred Morel
// http://fmorel90.github.io/peity
//
// Released under MIT license.
(function(n,u,G,J){var R=document.createElement("canvas").getContext,w=n.fn.canvis=function(a,b){R&&this.each(function(){var c=n(this),d=c.data(G);if(d)a&&(d.type=a),n.extend(!0,d.opt,b),d.draw();else{var g=w.defaults[a],e={};n.each(c.data(),function(a,b){e[a]=b});g=n.extend({},g,e,b);d=new K(c,a,g);d.draw();c.change(function(){d.draw()}).data(G,d)}});return this},K=function(a,b,c){this.$el=a;this.type=b;this.opt=c},l=K.prototype;l.draw=function(){w.graphers[this.type].call(this,this.opt)};l.createCanvas=
function(a,b){var c=this.canvas;c||(this.canvas=c=n("<canvas/>",{"class":"canvis"})[0],this.context=c.getContext("2d"),this.$el.hide().removeData(J).after(c));c.width=a;c.height=b;n(c).css({height:b,width:a}).data(G,this).off();return c};l.values=function(){var a=function(a){return parseFloat(a)},b=arguments,c=this.$el.text().split(b[0]);return 1===b.length?c.map(a):c.map(function(c){return c.split(b[1]).map(a)})};var l={color:"#000",size:13,formatter:function(a){return a}},y={labelLevels:function(a){return u.max.apply(this,
a.map(function(a){return a.replace(/[^ ]/g,"").length}))+1},toString:function(a,b){return b?a.map(function(a){return b(a)+""}):a.map(function(a){return a+""})},extractor:function(a){return function(b){return b[a]}},toFunction:function(a){return n.isArray(a)?n.isArray(a[0])||n.isFunction(a[0])?a.map(function(a){return n.isFunction(a)?a:function(c,d){return a[d%a.length]}}):function(b,c){return a[c%a.length]}:a},getWidth:function(a,b){return a.measureText(b).width}},O=function(a){var b=this.getBoundingClientRect();
n(this).off().prev().data(J,JSON.stringify({x:a.clientX-b.left,y:a.clientY-b.top})).change()},P=function(a){n(a).on("mousemove",O).on("mouseout",O)},v={arc:function(a,b,c,d,g,e,f,h){a.beginPath();a.arc(b,c,d,g,e,!0);a.lineWidth=h;a.strokeStyle=f;a.stroke()},circle:function(a,b,c,d,g,e,f){a.beginPath();a.moveTo(b,c);a.arc(b,c,d,g,e,!0);a.fillStyle=f;a.fill()},line:function(a,b,c,d){a.beginPath();a.moveTo(b[0].x,b[0].y);for(var g=1;g<b.length;g++)a.lineTo(b[g].x,b[g].y);a.lineWidth=d;a.strokeStyle=
c;a.stroke()},rect:function(a,b,c,d,g,e,f,h){e&&(a.fillStyle=e,a.fillRect(b,c,d,g));h&&(a.strokeStyle=h,a.lineWidth=f,a.strokeRect(b,c,d,g))},tooltip:function(a,b,c,d,g,e,f,h,p,C){a.font=e+"px sans-serif";a.textAlign="left";a.textBaseline="top";d=y.toString(d,h);p&&d.splice(0,0,y.toString([p],C)[0]);var r=u.max.apply([],d.map(function(b){return y.getWidth(a,b)}));h=y.getWidth(a,"\u25a0");var q=r+h;b-=6;h=d.length*e;c>h-6&&(c-=h);b<=q+7&&(b+=q+20+7);v.rect(a,b-q-4,c-3,q+7,h+8,"#fff",1,"#000");p&&(a.fillStyle=
f,a.fillText(d.splice(0,1)[0],b-q-2,c),c+=e);d.forEach(function(d,h){if(""!==d){var p=c+h*e;a.fillStyle=g[h%g.length];a.fillText("\u25a0",b-q-3,p);a.fillStyle=f;a.fillText(d,b-r-2,p)}})}};w.defaults={};w.graphers={};w.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};w.register("pie",{fill:["#f90","#ffd","#fc6"],line:{color:"#000",width:0},focus:{color:"#000",width:0},delimiter:null,diameter:16,tooltip:l,label:l},function(a){var b=a.delimiter;b||(b=(b=this.$el.text().match(/[^0-9\.]/))?
b[0]:",");var c=this.values.apply(this,[b]);"/"===b&&(c=[c[0],c[1]-c[0]]);var d,g=0,b=c.length;for(d=0;d<b;d++)g+=c[d];var e=this.$el.data(J),f=a.focus,h=a.line,p=u.max(f.width,h.width)+1,C=a.diameter,C=this.createCanvas(C+p,C+p),r=this.context;d=C.width;var q=C.height,p=d/2-p,s=2*u.PI,g=s/g,Q=y.toFunction(a.fill),n=a.tooltip,x=a.label,l;(a=a.labels)&&(a=y.toString(a));if(f.width&&e){var k=JSON.parse(e);k.x-=d/2;k.y-=q/2;k.y*=-1;k.r=u.sqrt(k.x*k.x+k.y*k.y);for(k.a=u.atan2(k.y,k.x);0>k.a;)k.a+=s;for(;k.a>
s;)k.a-=s}r.save();r.translate(d/2,q/2);var A,m=0;for(d=0;d<b;d++)q=c[d],A=q*g,v.circle(r,0,0,p,-m,-(m+A),Q.call(this,q,d,c)),f.width&&k&&k.a>m&&k.a<m+A&&k.r<p&&(v.arc(r,0,0,p+f.width/2,-m,-(m+A),f.color,f.width),l=d),m+=A;h.width&&v.arc(r,0,0,p+h.width/2,0,s,h.color,h.width);f.width&&(e&&void 0!==l&&(e=JSON.parse(e),r.restore(),v.tooltip(r,e.x,e.y,[c[l]],[Q.call(this,c[l],l,c)],n.size,n.color,n.formatter,a?a[l]:void 0,x.formatter)),P(C))});w.register("combo",{series:[{type:"bar",color:["#48f"]},
{type:"line",color:["#827"],width:1,points:3}],delimiters:["|",","],height:50,width:200,left:0,gap:1,seriesGap:0,max:null,min:0,xAxis:l,yAxis:l,tooltip:l,focus:{color:"#000",width:0},gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=this,c=b.values.apply(b,a.delimiters),d=[].concat.apply([a.max,a.min],c),g,e,f,h,p=a.labels,n=0;p&&(p=y.toString(p),n=y.labelLevels(p));var r=u.max.apply(u,c.map(function(a){return a.length}));e=u.max.apply(u,d);var q=u.min.apply(u,d),s,l=a.region||(e-
q)/5;0!==e&&(e=u.ceil(e+l/2));0!==q&&(q=u.floor(q-l/2));s=e-q||1;var l=a.region||s/5,w=a.series,x=w.filter(function(a){return"bar"===a.type}),G=x.length,x=a.yAxis,d=a.xAxis,k=a.focus,A=a.tooltip,m=a.gridlines,D=b.$el.data(J),N=b.createCanvas(a.width,a.height),t=b.context,z=N.width,L=a.gap,K=a.seriesGap,E=a.left;a=N.height-(n*d.size+(n?4:0))-m.widths[0];var M=e===q?0:a/s;s=(z-E-L*r)/r;m.widths[0]&&(h=a-M*(0-q),v.line(t,[{x:E,y:h},{x:z,y:h}],m.colors[0],m.widths[0]));if(m.widths[1])for(t.fillStyle=
x.color,t.font=x.size+"px sans-serif",t.textAlign="right",g=q;g<=e;g+=l)h=a-M*(g-q),v.line(t,[{x:E,y:h},{x:z,y:h}],m.colors[1],m.widths[1]),E&&(t.textBaseline=h>x.size/2?h>a-x.size/2?"bottom":"middle":"top",t.fillText(x.formatter(g)+"",E-2,h));var l=[],x=-1,B,H,F,I,m=[];for(e=0;e<r;e++)m.push(E+(L+s)*(0.5+e));for(e=0;e<c.length;e++){B=c[e];F=w[e];I=F.color=y.toFunction(F.color);H=F.type;"bar"===H&&x++;z=[];for(f=0;f<B.length;f++)g=B[f],h=a-M*(g-q),"bar"===H?(r={x:E+L/2+f*(L+s)+s/G*x,y:h,w:s/G-K/2,
h:0===g?1:M*g},v.rect(t,r.x,r.y,r.w,r.h,I.call(b,g,f,B),0)):r={x:m[f],y:h},z[f]=r,"step"===H&&g&&v.line(t,[{x:m[f]-s/2*0.62,y:h},{x:m[f]+s/2*0.62,y:h}],I.call(b,g,f,B),F.width);if("line"===H){for(f=0;f<z.length;f++)v.circle(t,z[f].x,z[f].y,F.points,0,2*u.PI,I.call(b,B[f],f,B));v.line(t,z,I.call(b,B[0],0,B),F.width)}l.push(z.slice(0))}if(n)for(t.fillStyle=d.color,t.font=d.size+"px sans-serif",t.textBaseline="top",t.textAlign="center",e=0;e<m.length;e++)for(n=p[e].split(" "),f=0;f<n.length;f++)t.fillText(n[f],
m[e],a+1+f*d.size);if(k.width){if(D)for(D=JSON.parse(D),f=0;f<m.length;f++)if(D.x>=m[f]-s/2&&D.x<=m[f]+s/2){for(e=0;e<l.length;e++)"bar"===w[e].type&&v.rect(t,l[e][f].x-k.width/2,l[e][f].y-k.width/2,l[e][f].w+k.width,l[e][f].h+k.width,void 0,k.width,k.color);v.tooltip(t,D.x,D.y,c.map(y.extractor(f)),c.map(function(a,c){return w[c].color.call(b,a[f],f,a)}),A.size,A.color,A.formatter,p?p[f]:void 0,d.formatter);break}P(N)}})})(jQuery,Math,"canvis","canvis-mouse");
